<%@page import="java.util.List"%>
<%@page import="java.util.HashMap"%>
<%@page import="java.util.ArrayList"%>
<%@page import="java.util.Collections"%>

<%@page import="java.text.DateFormat"%>
<%@page import="java.text.SimpleDateFormat"%>
<%@page import="java.util.Calendar"%>
<%@page import="java.util.Date"%>
<%@page import="adm.alumno.spring.AdmAcademico"%>
<%@page import="adm.alumno.spring.AdmSolicitud"%>
<%@page import="adm.alumno.spring.AdmCartaSubir"%>
<%@page import="adm.catalogo.spring.CatModalidad"%>
<%@page import="adm.catalogo.spring.CatCarrera"%>
<%@page import="adm.plan.spring.MapaPlan"%>
<%@page import="adm.alumno.spring.AdmIngreso"%>
<%@page import="adm.alumno.spring.AdmIngresoPlan"%>
<%@page import="adm.parametros.spring.AdmParametros"%>

<%@ include file= "../head.jsp"%>
<%@ include file= "../menu.jsp"%>
<head>	
	<link rel="stylesheet" href="<%=request.getContextPath()%>/js-plugins/chosen/chosen.css" /> 
	<style>		
		body{
			background-image: url("<%=request.getContextPath()%>/imagenes/Biblioteca.png");
			/* Para dejar la imagen de fondo centrada, vertical y horizontalmente */
			background-position: center center;
			/* La imagen se fija en la ventana de visualizaci�n para que la altura de la imagen no supere a la del contenido */
			background-attachment: fixed;
			background-repeat: no-repeat;
			/* La imagen de fondo se reescala autom�ticamente con el cambio del ancho de ventana del navegador */
			background-size: cover;	
		}				
		@media (min-width: 587px) {
			.col-md-3{
				float: left;
				margin-left: 85px;
			}
		}
		@media (min-width: 764px) {
			.col-md-3{
				float: left;
				margin-left: 0;
			}		
		}
		@media (min-width: 480px) {
			.col-md-5{
				float: left;
			}
		}	
	</style>		
</head>
<%	
	String folio 						= (String)session.getAttribute("Folio")==null?"0":(String)session.getAttribute("Folio");
	List<String> opciones				= (List<String>)session.getAttribute("Opciones");
	
	AdmAcademico admAcademico 			= (AdmAcademico) request.getAttribute("admAcademico");
	AdmSolicitud admSolicitud 			= (AdmSolicitud) request.getAttribute("admSolicitud");
	AdmCartaSubir admCartaSubir 		= (AdmCartaSubir)request.getAttribute("admCartaSubir");
	AdmParametros admParametros			= (AdmParametros)request.getAttribute("admParametros");

	boolean existeAcademico 			= (boolean) request.getAttribute("existeAcademico");
	String mensaje						= (String)request.getAttribute("mensaje");
	String colorGrabar					= existeAcademico?"style='color:green'":"style='color:orange'";	
	List<CatModalidad> lisModalidades	= (List<CatModalidad>) request.getAttribute("lisModalidades");	
	List<MapaPlan> lisPlanes			= (List<MapaPlan>) request.getAttribute("lisPlanes");	

	HashMap<String,String> mapaNivel 		= (HashMap<String,String>) request.getAttribute("mapaNivel");
	HashMap<String,String> mapaFacultades 	= (HashMap<String,String>) request.getAttribute("mapaFacultades");
	HashMap<String,CatCarrera> mapaCarreras = (HashMap<String,CatCarrera>) request.getAttribute("mapaCarreras");
	List<AdmIngreso> lisPeriodos 			= (List<AdmIngreso>)request.getAttribute("lisPeriodos");
	String periodoId						= (String)request.getAttribute("periodoId");
	String modo								= (String)request.getAttribute("modo");
	String planId							= (String)request.getAttribute("planId");
	String modalidadId						= (String)request.getAttribute("modalidadId");
	String fecha 							= request.getParameter("Fecha")==null ? "-" : request.getParameter("Fecha");
	String nivelEstudio 					= (String)request.getAttribute("nivelEstudio");

	// System.out.println(periodoId+":"+modo+":"+nivelEstudio); 
	System.out.println(lisPlanes.size());

%>
<body>
<div class="container-fluid">
	<div class="row">
		<%-- <%@ include file= "../opciones.jsp"%> --%>
		<div class="col-lg-12" style="background-color:white; min-height:calc(100vh - 37px);">
			<div class="d-flex bd-highlight page-header">
			<div class="p-2 w-100 bd-highlight">
			<h2><i class="fas fa-check-circle" aria-hidden="true" <%=colorGrabar%>></i>&nbsp;<spring:message code="solicitud.modalidad.Modalidad"/></h2>
		</div>
		<div class="p-2 flex-shrink-1 bd-highlight">
<%	if(existeAcademico){ %>
			<div class="d-flex justify-content-start position-absolute top-5 end-0">
				<div class="d-flex align-items-center">				
					<a href="<%=request.getContextPath()%>/inicial"><i class="fas fa-caret-left fa-3x"></i></a>
					&nbsp;<b class="fs-5">1/12</b>
					&nbsp;
					<a href="<%=request.getContextPath()%>/solicitud/datos"><i class="fas fa-caret-right fa-3x"></i></a>
					&nbsp;&nbsp;
				</div>
			</div>
<% 	}%>	  
		</div>
	</div>
	<div class="alert alert-info" role="alert">
		<spring:message code="solicitud.modalidad.ParteProceso"/>
	</div>
	<form name="frmPlan" action="modalidad" method="post">
		<input type="hidden" name="Accion"/>  
		<label for="PeriodoId"><b>Entry Period</b></label>
		<select class="form-select mb-4" name="PeriodoId" id="PeriodoId" onchange="javascript:document.frmPlan.submit();" style="width:200px">
<% 	for(AdmIngreso periodo : lisPeriodos){		 %>
			<option value="<%=periodo.getPeriodoId()%>" <%=periodo.getPeriodoId().equals(periodoId) ? "Selected" : "" %> ><%=periodo.getPeriodoNombre()%> </option>
<%	}%>
		</select>
		<label for="TipoAplicante"><b>Nationality Type</b></label>
		<select class="form-select mb-4" name="TipoAplicante" id="TipoAplicante" style="width:200px">
			<option value="N" <%=admSolicitud.getTipoAplicante().equals("N")?"selected":""%>>National Applicant</option>
			<option value="I" <%=admSolicitud.getTipoAplicante().equals("I")?"selected":""%>>International Applicant</option>
		</select>
		<label for="NivelEstudio"><b>Study Level</b></label>
		<select class="form-select mb-4" name="NivelEstudio" id="NivelEstudio" style="width:200px" onchange="javascript:document.frmPlan.submit();">
			<option value="U" <%=nivelEstudio.equals("U")?"selected":""%>>Undergraduate</option>
			<option value="P" <%=nivelEstudio.equals("P")?"selected":""%>>Postgraduate</option>
		</select>
		<label for="Tipo"><b>Application Type</b></label>
		<select class="form-select mb-4" name="Tipo" id="Tipo" style="width:200px">
			<option value="S" <%=admAcademico.getTipo().equals("S")?"selected":""%>>School Leaver</option>
			<option value="N" <%=admAcademico.getTipo().equals("N")?"selected":""%>>Non-School Leaver</option>
		</select>					
		<label for="PlanId"><b><spring:message code="adm.Carrera"/></b></label>
		<select class="form-select chzn-select mb-4" id="PlanId" name="PlanId" data-live-search="true" style="width:500px;" onchange="javascript:document.frmPlan.submit();">	
<%	String nivel			= "X";
	String nivelNom 		= "";
	String carreraNom 		= "";
	String facId 			= "X";
	for (MapaPlan plan : lisPlanes){ 
		if (!mapaCarreras.get(plan.getCarreraId()).getFacultadId().equals(facId)){	
			if (!facId.equals("X")) out.print("</optgroup>");
			if ( mapaCarreras.containsKey(plan.getCarreraId())){
				nivel 		= mapaCarreras.get(plan.getCarreraId()).getNivelId();	
				nivelNom 	= mapaNivel.get(nivel);
				carreraNom 	= mapaCarreras.get(plan.getCarreraId()).getNombreCarrera();	
				facId 		= plan.getCarreraId().substring(0, 3);
			}%>	
			<optgroup  class='group-result' style = 'font-size:11pt; font-weight:bold;' label="<%="Schoool of "+mapaFacultades.get(facId)%>">
	<%	} %>
				<option value="<%=plan.getPlanId()%>" <%=plan.getPlanId().equals(planId)?"Selected":""%>><%=plan.getPlanId()+"-"+plan.getNombrePlan()%></option>			
<%	}	%>	
			</optgroup>
		</select>	
		<label for="ModalidadId"><b>Attendance <spring:message code="adm.Modalidad"/></b></label>
		<select name="ModalidadId" id="ModalidadId" class="form-select mb-4" style="max-width:200px;" onchange="javascript:document.frmPlan.submit();">
<%	for(CatModalidad modalidad : lisModalidades){%>
			<option value="<%=modalidad.getModalidadId()%>" <%=modalidadId.equals(modalidad.getModalidadId())?"Selected":""%>><%=modalidad.getNombreModalidad()%></option>
<%	}%>
		</select>			
<%		if( admSolicitud.getEstado().equals("1")){ %>
		<button type="button" class="btn alert-info" onclick="javascript:Grabar();"><spring:message code="adm.Guardar"/></button>
<%		}%>
	</form>
</div>
</body>
<script> 
	function Grabar(){
		document.frmPlan.Accion.value = "1";
		document.frmPlan.submit();
	}
</script>
<script>
// Function to toggle Tipo select visibility
function toggleTipoSelect() {
    const nivelEstudio = document.getElementById("NivelEstudio");
    const tipoSelect = document.getElementById("Tipo");
    const tipoLabel = document.querySelector('label[for="Tipo"]');
    
    if (nivelEstudio.value === "U") {
        // Show Tipo select for Undergraduate
        tipoSelect.style.display = "block";
        tipoSelect.previousElementSibling.style.display = "block"; // Show the label
    } else {
        // Hide Tipo select for Postgraduate
        tipoSelect.style.display = "none";
        tipoSelect.previousElementSibling.style.display = "none"; // Hide the label
    }
}

// Add event listener to NivelEstudio select
document.getElementById("NivelEstudio").addEventListener("change", toggleTipoSelect);

// Run on page load to set initial state
document.addEventListener("DOMContentLoaded", function() {
    toggleTipoSelect();
});
</script>	
	
<%	if (mensaje.equals("1")){%>
	<div class="alert alert-success"><spring:message code="solicitud.modalidad.GraboModalidad"/></div>
	<meta http-equiv="refresh" content="1;url=datos" />
<%	}else if(mensaje.equals("2")||mensaje.equals("3")){%>
	<div class="alert alert-warning"><spring:message code="solicitud.modalidad.NoGraboModalidad"/></div>
<%	}%>