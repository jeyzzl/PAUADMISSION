<%@page import="java.util.List"%>
<%@page import="java.util.HashMap"%>
<%@page import="adm.alumno.spring.AdmSolicitud"%>
<%@page import="adm.alumno.spring.AdmAcademico"%>
<%@page import="adm.alumno.spring.AdmUsuario"%>
<%@page import="adm.alumno.spring.AdmEstudio"%>
<%@page import="adm.documento.spring.AdmFormato"%>
<%@page import="adm.documento.spring.AdmDocumento"%>
<%@page import="adm.documento.spring.AdmDocAlum"%>
<%@page import="adm.documento.spring.AdmRequisito"%>
<%@page import="adm.alumno.spring.AdmCartaSubir"%>
<%@page import="adm.parametros.spring.AdmParametros"%>

<%@ include file= "../head.jsp"%>
<%@ include file= "../menu.jsp"%>
<%
    String folio = (String)session.getAttribute("Folio")==null?"0":(String)session.getAttribute("Folio");
    List<String> opciones = (List<String>)session.getAttribute("Opciones");
    String colorImagen = "bg-warning";
    String colorArchivo = "style='color:#ff9633'";    
    
    AdmSolicitud admSolicitud   = (AdmSolicitud)request.getAttribute("admSolicitud");
    AdmAcademico admAcademico   = (AdmAcademico)request.getAttribute("admAcademico");    
    AdmUsuario admUsuario       = (AdmUsuario)request.getAttribute("admUsuario");    
    AdmCartaSubir admCartaSubir = (AdmCartaSubir)request.getAttribute("admCartaSubir");
    AdmParametros admParametros = (AdmParametros)request.getAttribute("admParametros");
    
    String nivelNombre = (String)request.getAttribute("nivelNombre");
    String carreraNombre = (String)request.getAttribute("carreraNombre");     
    String modalidad = admAcademico.getModalidad();
    String nivelEstudio = admSolicitud.getNivelEstudio();
    String tipo = admSolicitud.getTipo();
    String tipoAplicante = admSolicitud.getTipoAplicante();
    String edoCivil = admSolicitud.getEstadoCivil();

    boolean esEmpleado = (boolean)request.getAttribute("esEmpleado");
    boolean esOtros = (boolean)request.getAttribute("esOtros");

    String grabo 			= request.getParameter("Grabo")==null?"-":request.getParameter("Grabo");
    
    List<AdmRequisito> lisRequisitos = (List<AdmRequisito>)request.getAttribute("lisRequisitos"); 
    HashMap<String, AdmDocumento> mapDocumentos = (HashMap<String,AdmDocumento>)request.getAttribute("mapDocumentos");
    HashMap<String, AdmDocAlum> mapDocAlum = (HashMap<String,AdmDocAlum>)request.getAttribute("mapDocAlum");
    HashMap<String, AdmDocAlum> mapDocReqAlum = (HashMap<String,AdmDocAlum>)request.getAttribute("mapDocReqAlum");
    HashMap<String, AdmFormato> mapFormatos = (HashMap<String,AdmFormato>)request.getAttribute("mapFormatos");
    HashMap<String, String> mapImagen = (HashMap<String,String>)request.getAttribute("mapImagen");    
    HashMap<String, String> mapArchivo = (HashMap<String,String>)request.getAttribute("mapArchivo");

    String completos = request.getParameter("Completos")==null?"N":request.getParameter("Completos");

    // ===== DOCUMENT STATUS CALCULATION =====
    boolean tieneDocumentos = true; // Assume all documents are approved initially
    
    for(AdmRequisito requisito : lisRequisitos) {
        // Skip if not required
        if(requisito.getRequerido().equals("N")) continue;
        
        // Check if document applies to this student
        boolean aplica = false;
        String[] modalidades = requisito.getModalidades().split("-");
        for(String mod : modalidades) {
            if(mod.equals(modalidad)) {
                aplica = true;
                break;
            }
        }
        if(!aplica) continue;
        
        aplica = false;
        String[] niveles = requisito.getNiveles().split("-");
        for(String ne : niveles) {
            if(ne.equals(nivelEstudio)) {
                aplica = true;
                break;
            }
        }
        if(!aplica) continue;
        
        aplica = false;
        String[] tipos = requisito.getTipos().split("-");
        for(String tipoS : tipos) {
            if(tipoS.equals(tipo)) {
                aplica = true;
                break;
            }
        }
        if(!aplica) continue;
        
        aplica = false;
        String[] nacionalidades = requisito.getNacionalidades().split("-");
        for(String nacionalidad : nacionalidades) {
            if(nacionalidad.equals(tipoAplicante)) {
                aplica = true;
                break;
            }
        }
        if(!aplica) continue;

        aplica = false;
        String[] estadosCiviles = requisito.getEstadosCiviles().split("-");
        for(String estadoCivil : estadosCiviles) {
            if(estadoCivil.equals(edoCivil)) {
                aplica = true;
                break;
            }
        }
        if(!aplica) continue;
        
        // If we get here, the document is required for this student
        if(mapDocAlum.containsKey(folio+requisito.getDocumentoId())) {
            AdmDocAlum docAlum = mapDocAlum.get(folio+requisito.getDocumentoId());
            if(!"E".equals(docAlum.getEstado())) { // E status for Sent documents. A status for Approved documents
                tieneDocumentos = false;
                break;
            }
        } else {
            tieneDocumentos = false;
            break;
        }
    }

    if(admUsuario.getEmpleado().equals("S")){
        if(admUsuario.getInstitucionId().equals("1")){
            if(!mapDocAlum.containsKey(folio+"23")){
                tieneDocumentos = false;
            }
        }else{
            if(!mapDocAlum.containsKey(folio+"22")){
                tieneDocumentos = false;
            }
            if(!mapDocAlum.containsKey(folio+"23")){
                tieneDocumentos = false;
            }
        }
    }

    if(tieneDocumentos && ( admSolicitud.getEstado().equals("3") || admSolicitud.getEstado().equals("4") || admSolicitud.getEstado().equals("5"))) completos = "S";
    
    String colorGrabar = tieneDocumentos ? "style='color:green'" : "style='color:orange'";
%>
<head>
    <link rel="STYLESHEET" href="/admision.css"  type="text/css">
    <script src="../../js/jquery-1.5.1.min.js" type="text/javascript"></script>
    <script src='../../js/Globo/jquery.tinyTips2.js' type='text/javascript'></script>        
    <style>        
        body{
            background-image: url("<%=request.getContextPath()%>/imagenes/Biblioteca.png");
            /* Para dejar la imagen de fondo centrada, vertical y horizontalmente */
            background-position: center center;
            /* La imagen se fija en la ventana de visualización para que la altura de la imagen no supere a la del contenido */
            background-attachment: fixed;
            background-repeat: no-repeat;
            /* La imagen de fondo se reescala automáticamente con el cambio del ancho de ventana del navegador */
            background-size: cover;    
        } 
        a {text-decoration: none;} 
        a:hover {text-decoration: underline;} 
        .tabla td{padding:5px;}
        
        .tinyTip {
            width: 325px;
            padding: 17px 0px 0px 0px;
            display: block;
            background: url(js/Globo/tinyTip-top.png) 0px 0px no-repeat;
        }
        .tinyTip .content {
            padding: 0px 15px 0px 15px;
            font-size: 14px;
            font-family: "Lucida Sans Unicode";
            color: #010101;
            background: url(js/Globo/tinyTip-content.png) 0px 0px repeat-y;
        }
        .tinyTip .bottom {
            height: 47px;
            background: url(js/Globo/tinyTip-bottom.png) 0px 0px no-repeat;
            font: 0px/0px sans-serif;
        }
        .fa{
            color: black;
        }
        a> .fa{
            color: #337ab7;
        }
        
        @media (min-width: 587px) {
            .col-md-3{
                float: left;
                margin-left: 85px;
            }
        }
        @media (min-width: 764px) {
            .col-md-3{
                float: left;
                margin-left: 0;
            }        
        }
        @media (min-width: 480px) {
            .col-md-5{
                float: left;
            }
        }    
    </style>        
</head>
<script type="text/javascript">
    function confirmar(){
        if(confirm("Please review your documents carefully before submitting. You will not be able to make changes after submission.")){
           document.location.href = "confirmardocumentos";
        }
    }
</script>
<body>    
<div class="container-fluid">
    <div class="row">
        <%-- <%@ include file= "../opciones.jsp"%> --%>
        <div class="col-lg-12" style="background-color:white; min-height:calc(100vh - 37px);">
            <div class="d-flex page-header">
                <div class="p-2 w-100 bd-highlight">
                    <h2><i class="fas fa-check-circle" aria-hidden="true" <%=colorGrabar%>></i>&nbsp;<spring:message code='documentos.documentos.RequisitosAdmision'/><small class="text-muted fs-5">( <%=nivelNombre%> &nbsp;<spring:message code='documentos.documentos.Carrera'/>: <i><%=carreraNombre%></i> )</small></h2>
                </div>
                <div class="p-2 flex-shrink-1 bd-highlight">
                    <div class="d-flex align-items-center">
                        <a href="<%=request.getContextPath()%>/solicitud/banco"><i class="fas fa-caret-left fa-3x"></i></a>
                        &nbsp;<b class="fs-5">10/12</b>&nbsp;
<%                      if(tieneDocumentos && completos.equals("S")){%>
                        <a href="<%=request.getContextPath()%>/referencias?Folio=<%=folio%>"><i class="fas fa-caret-right fa-3x"></i></a>
<%                      }else{
                        	out.print("&nbsp;");
                        }%>
                    </div>
                </div>
            </div>
<!--    ADD DOCUMENTS FILTER -->
            <div class="alert alert-info" role="alert">
<%                if(admSolicitud.getEstado().equals("2")){%>
                    <spring:message code='documentos.documentos.DocumentosDigitalizados'/>&nbsp;                    
                    <spring:message code='documentos.documentos.EnviarArchivo'/><i class="fa fa-upload fa-1x" style='color:#ff9633'></i><br>
                    <spring:message code='documentos.documentos.FormatoQueLlenar'/><i class="fa fa-download fa-1x" style="color:#6487cb"></i>
                    <spring:message code='documentos.documentos.PosteriormenteEnviarlo'/><br>            
<%                }else if (admSolicitud.getEstado().equals("3")){%>
                <div class="text-center">
                    <h5 align="center"><font color="green"><b><spring:message code='documentos.documentos.DocumentosAutorizados'/></b></font></h5>
                </div>
<%                }else if(admSolicitud.getEstado().equals("1")){
                    out.print("<h4>You must complete the previous steps before uploading your documents</h4>");
                }
%>
            </div>
            <table class="table table-responsive table-sm table-bordered">
                <thead>
                    <tr class="table-dark">
                        <th width="3%"><b>#</b></th>
                        <th width="3%" class="text-center"><b>?</b></th>
                        <th width="20%"><b><spring:message code='documentos.documentos.Documento'/></b></th>
                        <th width="30%"><b>Description</b></th>
                        <th width="10%" class="text-center"><b>File</b></th>
                        <th width="10%"><b><spring:message code='documentos.documentos.Estado'/></b></th>    
                        <th width="15%"><b>Comment</b></th>            
                    </tr>
                </thead>
                <tbody style="background-color:white">                
<%      int cont = 0;
        for(AdmRequisito requisito : lisRequisitos){    
            // VALIDATE MODALITY            
            boolean existeModalidad = false;        
            String[] modalidades = requisito.getModalidades().split("-");        
            for(String mod : modalidades){            
                if(mod.equals(modalidad)){
                    existeModalidad = true;
                    break;
                }
            }

            // VALIDATE NIVEL
            boolean existeNivel = false;
            String[] niveles = requisito.getNiveles().split("-");
            for(String ne : niveles){
                if(ne.equals(nivelEstudio)){
                    existeNivel = true;
                    break;
                }
            }

            // VALIDATE TIPO
            boolean existeTipo = false;
            String[] tipos = requisito.getTipos().split("-");
            for(String tipoS : tipos){
                if(tipoS.equals(tipo)){
                    existeTipo = true;
                    break;
                }
            }

            // VALIDATE TIPO APLICANTE
            boolean existeTipoA = false;
            String[] nacionalidades = requisito.getNacionalidades().split("-");
            for(String nacionalidad : nacionalidades){
                if(nacionalidad.equals(tipoAplicante)){
                    existeTipoA = true;
                    break;
                }
            }

            // VALIDATE ESTADO CIVIL
            boolean existeEdoCivil = false;
            String[] estadosCiviles = requisito.getEstadosCiviles().split("-");
            for(String estadoCivil : estadosCiviles){
                if(estadoCivil.equals(edoCivil)){
                    existeEdoCivil = true;
                    break;
                }
            }
            
            // VALIDATE DOCUMENT STATUS
            if(!existeModalidad || !existeNivel || !existeTipo  || !existeTipoA || !existeEdoCivil) continue; else cont++;                
            AdmDocAlum docAlum = new AdmDocAlum(); 
            boolean existeDocAlum = false;
            if (mapDocAlum.containsKey(folio+requisito.getDocumentoId())){
                docAlum = mapDocAlum.get(folio+requisito.getDocumentoId());
                existeDocAlum = true;                
            }    
            
            // MAPS DOCUMENT
            AdmDocumento documento = new AdmDocumento();
            AdmFormato formato = new AdmFormato();
            boolean existeFormato = false;
            if (mapDocumentos.containsKey(requisito.getDocumentoId())){
                documento = mapDocumentos.get(requisito.getDocumentoId());
                if (mapFormatos.containsKey(documento.getFormatoId())){
                    formato = mapFormatos.get(documento.getFormatoId());
                    existeFormato = true;
                }
            }        
            
            // SKIPS DOCUMENT IF NOT REQUIRED
            // if(requisito.getRequerido().equals("N")) continue;
            
            if (mapArchivo.containsKey(folio+documento.getDocumentoId())) colorArchivo = ""; else colorArchivo = "style='color:#ff9633'";
%>    
            <tr>
                <td><%=cont%></td>
                <td class="text-center"><i class="fa fa-comment fa-1x globo" aria-hidden="true" title="<%=(documento.getComentario()==null||documento.getComentario().equals("-")) ? "<i>No comment</i>" : documento.getComentario()%>"></i></td>
                <td>                        
                    <%=documento.getDocumentoNombre()%>            
                </td>
                <td>
                    <%=documento.getComentario()%>
                </td>
                <td class="text-center">
<%          if(admSolicitud.getEstado().equals("2")){%>
                    <a href="archivo?documentoId=<%=documento.getDocumentoId()%>"><i class="fas fa-upload fa-1x" <%=colorArchivo%>></i></a>    
<%          } %>                
                </td>    
<!-- FORMATO -->
                <td>
<%              if(!existeDocAlum){ %>                
                    <i class="fa fa-exclamation-circle fa-1x"></i>&nbsp;
                    <spring:message code='documentos.documentos.NoEnviado'/>
<%              }else if(docAlum.getEstado().equals("E")){ %>
                    <%-- <img src="../imagenes/sandClock.png" height="15px">&nbsp; --%>
                    <spring:message code='documentos.documentos.EsperandoAprobacion'/>
<%              }else if(docAlum.getEstado().equals("A")){ %>
                    <i class="fas fa-check-square fa-1x"></i>&nbsp;
                    <spring:message code='documentos.documentos.Aprobado'/>                
<%              }else if(docAlum.getEstado().equals("N")){ %>
                    <spring:message code='documentos.documentos.NoAprobado'/>
<%              }%>
                </td>
                <td>            
<%              if(existeDocAlum && docAlum.getComentario()!=null && !docAlum.getComentario().equals("null") && !docAlum.getComentario().equals("-")){
                    out.print(docAlum.getComentario());
                }%>            
                </td>                
            </tr>                
<%      }%>   
<!-- EMPLOYEE REQUIREMENTS --> 
<%  if(esEmpleado){
        AdmDocumento endorsmentLetter = mapDocumentos.get("22");
        AdmDocumento employeeReference = mapDocumentos.get("23");

        AdmDocAlum docEndorsmentLettter = new AdmDocAlum();
        AdmDocAlum docEmployeeReference = new AdmDocAlum();

        boolean existeDocEL = false;
        boolean existeDocER = false;

        if (mapDocAlum.containsKey(folio+endorsmentLetter.getDocumentoId())){
            docEndorsmentLettter = mapDocAlum.get(folio+endorsmentLetter.getDocumentoId());
            existeDocEL = true;                
        }

        if (mapDocAlum.containsKey(folio+employeeReference.getDocumentoId())){
            docEmployeeReference = mapDocAlum.get(folio+employeeReference.getDocumentoId());
            existeDocER = true;                
        }

        String colorEL = "";
        if (mapArchivo.containsKey(folio+endorsmentLetter.getDocumentoId())) colorEL = ""; else colorEL = "style='color:#ff9633'"; 

        String colorER = "";
        if (mapArchivo.containsKey(folio+employeeReference.getDocumentoId())) colorER = ""; else colorER = "style='color:#ff9633'"; 

        if(!esOtros){
%>
            <tr>
                <td><%=cont%></td>
                <td class="text-center">
                    <i class="fa fa-comment fa-1x globo" aria-hidden="true" title="<%=(endorsmentLetter.getComentario()==null||endorsmentLetter.getComentario().equals("-")) ? "<i>No comment</i>" : endorsmentLetter.getComentario()%>"></i>
                </td>
                <td>                         
                    <%=endorsmentLetter.getDocumentoNombre()%>            
                </td>
                <td>
                    <%=endorsmentLetter.getComentario()%>
                </td>
                <td class="text-center">
<%          if(admSolicitud.getEstado().equals("2")){%>
                    <a href="archivo?documentoId=<%=endorsmentLetter.getDocumentoId()%>"><i class="fas fa-upload fa-1x" <%=colorEL%>></i></a>    
<%          } %>                
                </td>  
                <td>
<%              if(!existeDocEL){ %>                
                    <i class="fa fa-exclamation-circle fa-1x"></i>&nbsp;
                    <spring:message code='documentos.documentos.NoEnviado'/>
<%              }else if(docEndorsmentLettter.getEstado().equals("E")){ %>
                    <%-- <img src="../imagenes/sandClock.png" height="15px">&nbsp; --%>
                    <spring:message code='documentos.documentos.EsperandoAprobacion'/>
<%              }else if(docEndorsmentLettter.getEstado().equals("A")){ %>
                    <i class="fas fa-check-square fa-1x"></i>&nbsp;
                    <spring:message code='documentos.documentos.Aprobado'/>                
<%              }else if(docEndorsmentLettter.getEstado().equals("N")){ %>
                    <spring:message code='documentos.documentos.NoAprobado'/>
<%              }%>
                </td>
            </tr>
            <tr>
                <td><%=cont%></td>
                <td class="text-center">
                    <i class="fa fa-comment fa-1x globo" aria-hidden="true" title="<%=(employeeReference.getComentario()==null||employeeReference.getComentario().equals("-")) ? "<i>No comment</i>" : employeeReference.getComentario()%>"></i>
                </td>
                <td>                         
                    <%=employeeReference.getDocumentoNombre()%>            
                </td>
                <td>
                    <%=employeeReference.getComentario()%>
                </td>
                <td class="text-center">
<%          if(admSolicitud.getEstado().equals("2")){%>
                    <a href="archivo?documentoId=<%=employeeReference.getDocumentoId()%>"><i class="fas fa-upload fa-1x" <%=colorER%>></i></a>    
<%          } %>                
                </td>  
                <td>
<%              if(!existeDocER){ %>                
                    <i class="fa fa-exclamation-circle fa-1x"></i>&nbsp;
                    <spring:message code='documentos.documentos.NoEnviado'/>
<%              }else if(docEmployeeReference.getEstado().equals("E")){ %>
                    <%-- <img src="../imagenes/sandClock.png" height="15px">&nbsp; --%>
                    <spring:message code='documentos.documentos.EsperandoAprobacion'/>
<%              }else if(docEmployeeReference.getEstado().equals("A")){ %>
                    <i class="fas fa-check-square fa-1x"></i>&nbsp;
                    <spring:message code='documentos.documentos.Aprobado'/>                
<%              }else if(docEmployeeReference.getEstado().equals("N")){ %>
                    <spring:message code='documentos.documentos.NoAprobado'/>
<%              }%>
                </td>
            </tr>
<%
        }else{
%>
            <tr>
                <td><%=cont%></td>
                <td class="text-center">
                    <i class="fa fa-comment fa-1x globo" aria-hidden="true" title="<%=(employeeReference.getComentario()==null||employeeReference.getComentario().equals("-")) ? "<i>No comment</i>" : employeeReference.getComentario()%>"></i>
                </td>
                <td>                         
                    <%=employeeReference.getDocumentoNombre()%>            
                </td>
                <td>
                    <%=employeeReference.getComentario()%> 
                </td>
                <td class="text-center">
<%          if(admSolicitud.getEstado().equals("2")){%>
                    <a href="archivo?documentoId=<%=employeeReference.getDocumentoId()%>"><i class="fas fa-upload fa-1x" <%=colorER%>></i></a>    
<%          } %>                
                </td>  
                <td>
<%              if(!existeDocER){ %>                
                    <i class="fa fa-exclamation-circle fa-1x"></i>&nbsp;
                    <spring:message code='documentos.documentos.NoEnviado'/>
<%              }else if(docEmployeeReference.getEstado().equals("E")){ %>
                    <%-- <img src="../imagenes/sandClock.png" height="15px">&nbsp; --%>
                    <spring:message code='documentos.documentos.EsperandoAprobacion'/>
<%              }else if(docEmployeeReference.getEstado().equals("A")){ %>
                    <i class="fas fa-check-square fa-1x"></i>&nbsp;
                    <spring:message code='documentos.documentos.Aprobado'/>                
<%              }else if(docEmployeeReference.getEstado().equals("N")){ %>
                    <spring:message code='documentos.documentos.NoAprobado'/>
<%              }%>
                </td>
            </tr>
<%           
        }
    }
%>
            </tbody>
            </table>
<%  if(tieneDocumentos && completos.equals("N")){%>
            <div class="text-center">
                <button onclick="javascript:confirmar();" class="btn btn-success text-decoration-none">Submit Documents</button>
            </div>
<%  }%>
        </div>
    </div>
</div>        
</body>
<% if (grabo.equals("S")){%>
	<table align="center"><tr><td><spring:message code="solicitud.salud.Grabo"/></td></tr></table>
	<meta http-equiv="refresh" content="1;url=<%=request.getContextPath()%>/referencias" />
<% }else if(grabo.equals("N")){%>
	<table align="center"><tr><td><spring:message code="solicitud.salud.NoGrabo"/></td></tr></table>
<% }%>